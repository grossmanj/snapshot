@model CustomerSnapshot.Domain.Models.CustomerSnapshotViewModel
@{
    ViewData["Title"] = "Customer Snapshot";
    string FormatCurrency(decimal value) => string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C0}", value);
    string FormatPercent(decimal value) => string.Format("{0:N1}%", value);
}

<div class="row mb-4">
    <div class="col-12">
        <div class="card p-4">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between">
                <div>
                    <h2 class="fw-bold mb-0">@Model.Customer.Name</h2>
                    <div class="text-muted">ID: @Model.Customer.Code · Segment: @Model.Customer.Segment · Industry: @Model.Customer.Industry</div>
                </div>
                <div class="text-end text-muted">Last refreshed @Model.Customer.LastRefreshedUtc.ToLocalTime().ToString("g")</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12"><h5 class="fw-bold">Top KPIs</h5></div>
    <div class="col-6 col-lg-3">
        <div class="card p-3 h-100">
            <div class="text-muted">Total Spend YTD</div>
            <div class="kpi-value">@FormatCurrency(Model.Kpis.TotalSpendYtd)</div>
            <small class="text-muted">Last year: @FormatCurrency(Model.Kpis.TotalSpendLastYear)</small>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card p-3 h-100">
            <div class="text-muted">% Delta vs LY</div>
            <div class="kpi-value @((Model.Kpis.PercentDeltaVsLy >=0 ? "text-success" : "text-danger"))">@FormatPercent(Model.Kpis.PercentDeltaVsLy)</div>
            <small class="text-muted">Risk: @Model.Kpis.RiskRating</small>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card p-3 h-100">
            <div class="text-muted">Avg Order Size</div>
            <div class="kpi-value">@FormatCurrency(Model.Kpis.AverageOrderSizeYtd)</div>
            <small class="text-muted">LY: @FormatCurrency(Model.Kpis.AverageOrderSizeLastYear)</small>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card p-3 h-100">
            <div class="text-muted">Payment Behavior</div>
            <div class="kpi-value">@Model.Kpis.PaymentBehavior</div>
            <small class="text-muted">Avg days to pay: @Model.Kpis.AverageDaysToPay · Late: @Model.Kpis.PercentInvoicesLate:N1% </small>
        </div>
    </div>
</div>
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
        <div class="card p-3 h-100">
            <div class="text-muted">Margin Trend</div>
            <div class="kpi-value">@Model.Kpis.MarginTrend</div>
        </div>
    </div>
    <div class="col-12 col-lg-8">
        <div class="card p-3 h-100 d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between">
            <div>
                <div class="text-muted">Total Spend LY</div>
                <div class="kpi-value">@FormatCurrency(Model.Kpis.TotalSpendLastYear)</div>
            </div>
            <div>
                <div class="text-muted">Risk Rating</div>
                <span class="pill bg-light text-dark">@Model.Kpis.RiskRating</span>
            </div>
            <div>
                <div class="text-muted">Delta</div>
                <span class="pill bg-light text-dark">@FormatPercent(Model.Kpis.PercentDeltaVsLy)</span>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Open Quotes</h5>
                <span class="pill bg-primary text-white">@Model.OpenQuotes.OpenCount open</span>
            </div>
            <div class="text-muted mb-2">Total open value: @FormatCurrency(Model.OpenQuotes.TotalOpenValue)</div>
            <ul class="list-group list-group-flush">
                @if (!Model.OpenQuotes.TopQuotes.Any())
                {
                    <li class="list-group-item">No open quotes.</li>
                }
                else
                {
                    @foreach (var quote in Model.OpenQuotes.TopQuotes)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">@quote.QuoteNumber</div>
                                <div class="text-muted small">@quote.QuoteDate:d · @quote.Description</div>
                            </div>
                            <div class="fw-bold">@FormatCurrency(quote.Amount)</div>
                        </li>
                    }
                }
            </ul>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Open Issues</h5>
                <span class="pill @(Model.OpenIssues.HasHighSeverity ? "bg-danger text-white" : "bg-warning-subtle text-dark")">@Model.OpenIssues.OpenCount open</span>
            </div>
            <ul class="list-group list-group-flush">
                @if (!Model.OpenIssues.TopIssues.Any())
                {
                    <li class="list-group-item">No open issues.</li>
                }
                else
                {
                    @foreach (var issue in Model.OpenIssues.TopIssues)
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <span class="fw-semibold">@issue.Summary</span>
                                <span class="pill bg-light text-dark">@issue.Severity</span>
                            </div>
                            <div class="text-muted small">@issue.Status · @issue.CreatedOn:d</div>
                        </li>
                    }
                }
            </ul>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card p-3">
            <h5 class="mb-3">Last 5 Interactions</h5>
            <div class="timeline position-relative">
                @if (!Model.RecentInteractions.Any())
                {
                    <div class="text-muted">No interactions logged.</div>
                }
                else
                {
                    @foreach (var interaction in Model.RecentInteractions)
                    {
                        <div class="timeline-item">
                            <div class="fw-semibold">@interaction.InteractionType · @interaction.InteractionDate:g</div>
                            <div class="text-muted">@interaction.Subject</div>
                            <div class="small text-muted">Owner: @interaction.Owner</div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Customer Personality Profile</h5>
            <p class="mb-1"><strong>Communication:</strong> @Model.Personality.CommunicationPreference</p>
            <p class="mb-1"><strong>Value orientation:</strong> @Model.Personality.ValueOrientation</p>
            <p class="mb-1"><strong>Response cadence:</strong> @Model.Personality.ResponseCadence</p>
            <p class="text-muted">@Model.Personality.Notes</p>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
            <h5>Talking Points for Your Next Conversation</h5>
            <ul class="mb-0">
                @foreach (var point in Model.TalkingPoints)
                {
                    <li class="mb-2">
                        <div class="fw-semibold">@point.Title</div>
                        <div class="text-muted">@point.Detail</div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-12">
        <div class="card cta-card p-4">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                <div>
                    <h4 class="fw-bold mb-1">@Model.NextAction.Label</h4>
                    <div>@Model.NextAction.Explanation</div>
                </div>
                <div>
                    <a class="btn btn-light mt-3 mt-md-0" href="mailto:?subject=Next step for @Model.Customer.Name">Email myself this action</a>
                </div>
            </div>
        </div>
    </div>
</div>
